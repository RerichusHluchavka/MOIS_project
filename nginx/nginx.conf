worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;

    resolver 127.0.0.11 valid=5s;

    server {
        listen 80;
        server_name localhost;

        # -----------------------------------------------
        # 1. Autentizace: /api/auth/* -> auth-service:3000
        # -----------------------------------------------
        location /api/auth/ {
            # auth-service je název kontejneru/služby v docker-compose
            proxy_pass http://auth-service:3000/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # -----------------------------------------------
        # 2. Vězňové: /api/prisoners/* -> prisoner-service:3001
        # -----------------------------------------------
        location /api/prison/ {
            proxy_pass http://prisoner-service:3001/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # -----------------------------------------------
        # 3. Sklad: /api/inventory/* -> inventory-service:3002
        # -----------------------------------------------
        location /api/inventory/ {
            proxy_pass http://inventory-service:3002/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # -----------------------------------------------
        # 4. Kuchyně: /api/kitchen/* -> kitchen-service:3003
        # -----------------------------------------------
        location /api/kitchen/ {
            proxy_pass http://kitchen-service:3003/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Defaultní cesty pro kontrolu
        location / {
            return 200 'API Gateway is operational.';
        }

        # -----------------------------------------------
        # 5. Platby: /api/payments/* -> payment-service:3005
        # -----------------------------------------------
        # Tento endpoint bude obsluhovat požadavky z vašeho frontend kódu,
        # které volají Express API pro vytvoření platebního záměru (Payment Intent).
        location /api/payments/ {
            # payment-service je název kontejneru/služby v docker-compose
            proxy_pass http://payment-service:3005/; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # -----------------------------------------------
        # 6. Stripe Webhook: /webhook/stripe -> payment-service:3005
        # -----------------------------------------------
        # Tento endpoint je kritický a musí být **veřejně přístupný** pro Stripe.
        # Sem Stripe pošle zprávu o výsledku platby.
        location /webhook/stripe {
            # Přesměrujte přímo na webhook endpoint v kontejneru
            proxy_pass http://payment-service:3005/webhook;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Doporučené hlavičky pro webhooks
            proxy_buffering off;
            proxy_request_buffering off;
        }   
    }
}