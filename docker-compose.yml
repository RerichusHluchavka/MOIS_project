
services:

  api-gateway:
    build:
      context: ./nginx # Předpokládá složku 'nginx' s Dockerfile a nginx.conf
    ports:
      - "80:80" # JEDINÝ exponovaný port pro frontend
    networks:
      - prison-net # Připojeno k interní síti
    depends_on: 
      - auth-service
      - prisoner-service
      - inventory-service
      - kitchen-service
      - payment-service

  # Authentication Service Database
  auth-db:
    image: postgres:15
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    volumes:
      - auth_data:/var/lib/postgresql/data
    networks:
      - prison-net

  # Authentication Service - Node.js Application
  auth-service:
    build: ./auth-service
    environment:
      DB_HOST: auth-db
      DB_PORT: 5432
      DB_NAME: auth_db
      DB_USER: admin
      DB_PASSWORD: admin
      JWT_SECRET: jwt-secret-key-change-in-production
      JWT_EXPIRES_IN: 24h
      PORT: 3000
      NODE_ENV: development
    depends_on:
      - auth-db
    volumes:
      - ./auth-service:/app  
      - /app/node_modules
    networks:
      - prison-net

  # Prisoner Service Database
  prisoner-db:
    image: postgres:15
    environment:
      POSTGRES_DB: prisoner_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    volumes:
      - prisoner_data:/var/lib/postgresql/data
    networks:
      - prison-net

  # Prisoner Service - Node.js Application
  prisoner-service:
    build: ./prisoner-service
    environment:
      DB_HOST: prisoner-db
      DB_PORT: 5432
      DB_NAME: prisoner_db
      DB_USER: admin
      DB_PASSWORD: admin
      JWT_SECRET: jwt-secret-key-change-in-production
      PORT: 3001
      NODE_ENV: development
    depends_on:
      - auth-service
      - prisoner-db
    volumes:
      - ./prisoner-service:/app  
      - /app/node_modules
    networks:
      - prison-net

  # Inventory Service Database  
  inventory-db:
    image: postgres:15
    environment:
      POSTGRES_DB: inventory_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    volumes:
      - inventory_data:/var/lib/postgresql/data
    networks:
      - prison-net

  # Inventory Service - Node.js Application
  inventory-service:
      build: ./inventory-service
      environment:
        DB_HOST: inventory-db
        DB_PORT: 5432
        DB_NAME: inventory_db
        DB_USER: admin
        DB_PASSWORD: admin
        JWT_SECRET: jwt-secret-key-change-in-production
        PORT: 3002
        NODE_ENV: development
      depends_on:
        - auth-service
        - inventory-db
      volumes:
        - ./inventory-service:/app  
        - /app/node_modules
      networks:
      - prison-net


  # Kitchen Service Database
  kitchen-db:
    image: postgres:15
    environment:
      POSTGRES_DB: kitchen_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    volumes:
      - kitchen_data:/var/lib/postgresql/data
    networks:
      - prison-net

  # Kitchen Service - Node.js Application
  kitchen-service:
    build: ./kitchen-service
    environment:
      DB_HOST: kitchen-db
      DB_PORT: 5432
      DB_NAME: kitchen_db
      DB_USER: admin
      DB_PASSWORD: admin
      JWT_SECRET: jwt-secret-key-change-in-production
      PORT: 3003
      NODE_ENV: development
    depends_on:
      - auth-service
      - kitchen-db
    volumes:
      - ./kitchen-service:/app  
      - /app/node_modules #bylo zakomentované
    networks:
      - prison-net

  payment-service:
      build: ./payment-service
      container_name: payment-service
      # Port nemusíte vystavovat ven, pokud ho používáte jen interně
      expose: 
        - "3005" 
      environment:
        STRIPE_SECRET_KEY: ${TEST_STRIPE_SECRET_KEY} 
        STRIPE_WEBHOOK_SECRET: ${TEST_STRIPE_WEBHOOK_SECRET}
      networks:
        - prison-net
      volumes:
        - ./payment-service:/app  
        - /app/node_modules

volumes:
  auth_data:
  prisoner_data:
  inventory_data:
  kitchen_data:

networks:
  prison-net:
    driver: bridge # Definice interní sítě